---
layout: post
current: post
thumbnail: 'assets/images/operating_system/thumbnail/os_thumbnail.jpeg'
cover:
navigation: True
title: '(3) 프로그램의 구조와 실행'
date: 2021-03-28 10:18:00
tags: [os]
class: post-template
subclass: 'post'
author: zangzangs
---

## 프로그램의 실행

프로그램의 실행은 두가지 중요한 의미를 가진다.
1. 파일 시스템에 존재하던 실행파일이 메모리에 적재된다는 의미
2. 프로그램이 CPU를 할당받고 명령을 수행하고 있는 상태

파일 시스템에 있는 실행 파일이 메모리에 적재될 때, 실행파일 전체가 메모리에 올라가지 않는다. 일부분만 메모리에 올라가고 나머지는 디스크의 특정영역인 스왑 영역에 존재한다.

<br/>

## 가상 메모리 (virtual memory)

프로세스의 주소 공간은 코드(code), 데이타(data), 스택(stack)영역으로 구성된다. 이러한 주소 공간을 우리는 가상 메모리 (또는 논리적 메모리: logical memory)라고 부른다.

- code
  - 사용자가 작성한 프로그램 함수들의 코드가 CPU에서 수행할 수 있는 기계어 명령 형태로 변환되어 저장되는 공간
- data
  - 전역 변수 등 프로그램이 사용하는 데이터를 저장하는 공간
- stack
  - 호출된 함수의 수행을 마치고 복귀할 주소 및 데이터를 임시로 저장하는 공간

<br/>

## 커널 주소 공간의 내용

운영체제도 하나의 프로세스이기 때문에 커널 역시 동일한 주소 공간인 code, data, stack 영역을 갖는다.

- #### code
  - 시스템 콜, 인터럽트 처리 코드
  - CPU, 메모리 등 자원 관리를 위한 코드
  - 편리한 인터페이스 제공을 위한 코드
- #### data
  - PCB(Process Controll Block)  
    - 현재 수행 중인 프로세스의 상태, CPU 사용 정보 등을 유지하기 위한 자료구조  
  - CPU, Memory 등 하드웨어 자원을 관리하기 위한 자료구조가 저장  
- #### stack
  - 각 Process의 커널 스택을 저장
    - 프로세스는 함수 호출시 자신의 복귀 주소를 저장하지만, 커널은 커널 내의 주소가 된다.
    - 각각의 프로세스마다 별도의 스택을 두어 관리한다.

<br/>

## 사용자 프로그램이 사용하는 함수
함수는 크게 두가지로 나눌 수 있다. 프로세스 함수와 커널함수

  - 사용자 정의 함수(프로세스 함수)  
    - 자신의 프로그램에서 정의한 함수  
  - 라이브러리 함수(프로세스 함수)  
    - 자신의 프로그램에서 정의하지 않고 갖다 쓴 함수  
    - 자신의 프로그램의 실행 파일에 포함되어 있다.  
<br/>
  - 커널 함수  
    - 운영체제 프로그램의 함수  
    - 커널 함수의 호출 = 시스템 콜  

<br/>

## 인터럽트

CPU는 매번 프로그램 카운터가 가리키고 있는 지점의 명령을 하나씩 수행하고 나서, 다음 명령을 수행하기 직전에 인터럽트 라인이 세팅되었는지 체크한다. 인터럽트 라인 체크를 통해 인터럽트가 발생했으면 CPU는 현재 수행하던 프로세스를 멈추고 운영체제의 인터럽트 처리 루틴으로 이동해서 인터럽트 처리를 수행한다.

> 그렇다면 인터럽트 처리중에 또다른 인터럽트가 발생하는 경우는 어떻게 되는가?

- 원직적으로는 인터럽트 처리중에 또 다른 인터럽트의 처리를 허용하지 않는다. 
  - 앞서 변경중이던 데이터를 또다른 인터럽트가 발생해 처리하게 되면 의도하지 않은 결과값으로 바뀔 수 있기 때문이다.
- 예외적인 경우가 존재한다.
  - 인터럽트마다 중요도가 다르다.
  - 상대적으로 낮은 중요도를 가진 인터럽트를 처리하는 도중 높은 중요도의 인터럽트 발생을 허용한다.

<br/>

## 프로세스의 두 가지 실행 상태
 mode bit에 따라 user mode, kernel mode를 반복하며 실행된다. 프로그램이 시작되어 종료될 때까지 다양한 함수 호출을 하며 실행되는데, 이를 사용자 모드와 커널모드의 실행 상태로 구분 지을 수 있다

- 사용자 모드(user mode)
  - 프로그램이 사용자 정의함수나 라이브러리 함수를 호출
  - 시스템 콜의 실행이 끝나고 시스템 콜 이후의 명령을 수행하는 경우
- 커널 모드(kernel mode)
  - 시스템 콜을 하는 경우
  - 프로그램의 실행이 끝날 때 커널모드로 진입하여 프로그램을 종료함

<br>